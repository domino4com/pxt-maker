# cloudbuild.yaml — build pxt-maker (repo root) and deploy to Firebase Hosting
# Project values:
#   _FIREBASE_PROJECT: springbot-co-za
#   _FIREBASE_SITE: springbot
#   _GITHUB_ORG: domino4com

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _FIREBASE_PROJECT: springbot-co-za
  _FIREBASE_SITE: springbot
  _GITHUB_ORG: domino4com

steps:
# Clone PXT core + common packages into /workspace
- name: 'gcr.io/cloud-builders/git'
  args: ['clone', 'https://github.com/${_GITHUB_ORG}/pxt', 'pxt']

- name: 'gcr.io/cloud-builders/git'
  args: ['clone', 'https://github.com/${_GITHUB_ORG}/pxt-common-packages', 'pxt-common-packages']

# Build PXT core (npm install; not ci, since upstream often has no lockfile)
- name: 'node:18'
  dir: 'pxt'
  entrypoint: 'bash'
  args:
    - -lc
    - |
      set -euo pipefail
      npm install
      npm run build

# Install common packages
- name: 'node:18'
  dir: 'pxt-common-packages'
  entrypoint: 'bash'
  args: ['-lc', 'set -euo pipefail; npm install' ]

# Install deps for your pxt-maker fork (repo root)
# - Install libudev headers so native 'usb' can compile if it still appears.
# - Also pass --no-optional to skip optional native deps we don’t need for static site.
# - Silence Browserslist “outdated” warnings to reduce noise.
- name: 'node:18'
  entrypoint: 'bash'
  args:
    - -lc
    - |
      set -euo pipefail
      export BROWSERSLIST_IGNORE_OLD_DATA=1
      apt-get update
      DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        build-essential python3 pkg-config libudev-dev
      rm -rf /var/lib/apt/lists/*
      npm install --no-optional

# Link local pxt + common packages into this target (via npx)
- name: 'node:18'
  entrypoint: 'bash'
  args:
    - -lc
    - |
      set -euo pipefail
      npx pxt link ./pxt
      npx pxt link ./pxt-common-packages

# Build static package to ./site (via npx). Also write minimal firebase.json
- name: 'node:18'
  entrypoint: 'bash'
  args:
    - -lc
    - |
      set -euo pipefail
      export BROWSERSLIST_IGNORE_OLD_DATA=1
      npx pxt staticpkg --githubpages --output ./site
      cat > firebase.json <<'JSON'
      { "hosting": { "public": "site", "ignore": ["firebase.json", "**/.*", "**/node_modules/**"] } }
      JSON

# Ensure Hosting site exists; then deploy using FIREBASE_TOKEN from Secret Manager
- name: 'node:18'
  entrypoint: 'bash'
  secretEnv: ['FIREBASE_TOKEN']
  args:
    - -lc
    - |
      set -euo pipefail
      npx firebase-tools hosting:sites:create "${_FIREBASE_SITE}" --project "${_FIREBASE_PROJECT}" || true
      npx firebase-tools deploy --non-interactive \
        --only hosting \
        --project "${_FIREBASE_PROJECT}" \
        --site "${_FIREBASE_SITE}"

availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/FIREBASE_TOKEN/versions/latest
    env: 'FIREBASE_TOKEN'
